<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>THE DUCK GO - ë•ì˜, ë•ì— ì˜í•œ, ë•ì„ ìœ„í•œ</title>
  <meta name="description" content="K-POP ì•„ì´ëŒ ë•í›„ë“¤ì˜ ë†€ì´í„° - ë®¤ì§ë¹„ë””ì˜¤, ìŠ¤ì¼€ì¤„, íˆ¬í‘œ, SNS ëª¨ìŒ">
  
  <!-- PWA Meta Tags -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#EA580C">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="THE DUCK GO">
  <link rel="apple-touch-icon" href="/icon-192.png">
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¥</text></svg>">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    const supabase = window.supabase.createClient(
      'https://hhschqwevdvhkarqkpsi.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhoc2NocXdldmR2aGthcnFrcHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2OTI3OTgsImV4cCI6MjA3OTI2ODc5OH0.E1xQxCLqyxr9TLe0iOXJqHb9p8Z-oV4fFfeMw5OrhG0'
    );

    // ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸ë“¤
    const Play = ({ className, fill }) => (
      <svg className={className} fill={fill || "none"} stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polygon points="5 3 19 12 5 21 5 3"></polygon>
      </svg>
    );
    
    const Calendar = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );
    
    const TrendingUp = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );
    
    const MessageSquare = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
    );
    
    const Heart = ({ className }) => (
      <svg className={className} fill="currentColor" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
      </svg>
    );
    
    const X = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );
    
    const Instagram = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
        <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
        <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
      </svg>
    );
    
    const Twitter = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
      </svg>
    );
    
    const Youtube = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path>
        <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
      </svg>
    );
    
    const Music = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M9 18V5l12-2v13"></path>
        <circle cx="6" cy="18" r="3"></circle>
        <circle cx="18" cy="16" r="3"></circle>
      </svg>
    );
    
    const Eye = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
    );
    
    const Bell = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
      </svg>
    );
    
    const Users = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
    );
    
    const Send = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    );
    
    const UserPlus = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="8.5" cy="7" r="4"></circle>
        <line x1="20" y1="8" x2="20" y2="14"></line>
        <line x1="23" y1="11" x2="17" y2="11"></line>
      </svg>
    );
    
    const Check = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    );

    // ì•Œë¦¼ ì†Œë¦¬ í•¨ìˆ˜
    const playNotificationSound = () => {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWm98OihUBELTKXh8bllHAU2jdXyzn0vBSh+zPDijz4KFF607OyrWBQLTKPg8bllHAU3jtXyz34vBSh+zPDijz4KFF2z6OyrWRQLTKPf8blmHQU2jdXyzn0wBSiAzfDijz4KFF607OyrWBQLTKPf8blmHQU3jtXyzn4wBSh/zPDijz4KFF607OyrWBQLTKPf8blmHQU3jtXyzn4vBSh/zPDijz4KFF607OyrWBQLTKPf8blmHQU3jtXyzn4vBSh/zPDijz4KFF607OyrWBQLTKPf8blmHQU3jtXyzn4vBSh/zPDijz4KFF607OyrWBQLTKPf8blmHQU3jtXyzn4vBSh/zPDijz4KFF607OyrWBQLTKPf8blmHQU3jtXyzn4vBSh/zPDijz4KFF607OyrWBQLTKPf8blmHQU3jtXyzn4vBSh/zPDijz4KFF607OyrWBQLTKPf8blmHQU3jtXyzn4vBSh/zPDijz4K');
      audio.volume = 0.3;
      audio.play().catch(e => console.log('ì•Œë¦¼ ì†Œë¦¬ ì¬ìƒ ì‹¤íŒ¨:', e));
    };

    function TheDuckGo() {
      const [selectedVideo, setSelectedVideo] = useState(null);
      const [activeCategory, setActiveCategory] = useState('all');
      const [resetDate, setResetDate] = useState('');
      const [showAdminPage, setShowAdminPage] = useState(false);

      const [voteData, setVoteData] = useState([]);
      const [loadingIdols, setLoadingIdols] = useState(true);
      const [schedules, setSchedules] = useState([]);
      const [loadingSchedules, setLoadingSchedules] = useState(true);
      const [posts, setPosts] = useState([]);
      const [loadingPosts, setLoadingPosts] = useState(true);
      const [user, setUser] = useState(null);
      const [showAuthModal, setShowAuthModal] = useState(false);
      const [showPostModal, setShowPostModal] = useState(false);
      const [showIdolSuggestionModal, setShowIdolSuggestionModal] = useState(false);
      const [selectedPost, setSelectedPost] = useState(null);
      const [authMode, setAuthMode] = useState('login');
      
      // ë©”ì‹ ì € & ì•Œë¦¼ & ì¹œêµ¬
      const [showMessenger, setShowMessenger] = useState(false);
      const [showNotifications, setShowNotifications] = useState(false);
      const [showFriends, setShowFriends] = useState(false);
      const [messages, setMessages] = useState([]);
      const [friendRequests, setFriendRequests] = useState([]);
      const [friends, setFriends] = useState([]);
      const [unreadCount, setUnreadCount] = useState(0);
      const [notificationCount, setNotificationCount] = useState(0);
      const prevUnreadCountRef = useRef(0);
      const prevNotificationCountRef = useRef(0);

      useEffect(() => {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        setResetDate(`${year}ë…„ ${month}ì›”`);
        
        fetchIdols();
        fetchSchedules();
        fetchPosts();
        checkUser();
      }, []);
      
      useEffect(() => {
        if (user) {
          const interval = setInterval(() => {
            fetchFriendRequests(user.id);
            fetchUnreadMessages(user.id);
          }, 3000); // 3ì´ˆë§ˆë‹¤ ì²´í¬
          
          return () => clearInterval(interval);
        }
      }, [user]);
      
      const checkUser = async () => {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (user) {
          const { data: userData } = await supabase
            .from('users')
            .select('id, nickname, email')
            .eq('id', user.id)
            .single();
          
          if (userData) {
            setUser({ ...user, ...userData });
            fetchFriendRequests(user.id);
            fetchUnreadMessages(user.id);
          } else {
            setUser(null);
          }
        } else {
          setUser(null);
        }
      };
      
      const fetchMessages = async (userEmail) => {
        try {
          const { data, error } = await supabase
            .from('messages')
            .select('*')
            .or(`from_user.eq.${userEmail},to_user.eq.${userEmail}`)
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          setMessages(data || []);
          
          // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ê°œìˆ˜
          const unread = data?.filter(m => m.to_user === userEmail && !m.is_read).length || 0;
          setUnreadCount(unread);
        } catch (error) {
          console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      };
      
      const fetchFriendRequests = async (userId) => {
        try {
          const { data, error } = await supabase
            .from('friendships')
            .select(`
              id,
              user_id,
              users!friendships_user_id_fkey(id, nickname)
            `)
            .eq('friend_id', userId)
            .eq('status', 'pending');
          
          if (error) throw error;
          
          const newCount = data?.length || 0;
          // ì´ì „ë³´ë‹¤ ì¦ê°€í–ˆì„ ë•Œë§Œ ì†Œë¦¬ ì¬ìƒ
          if (newCount > prevNotificationCountRef.current) {
            playNotificationSound();
          }
          
          prevNotificationCountRef.current = newCount;
          setNotificationCount(newCount);
          setFriendRequests(data || []);
        } catch (error) {
          console.error('ì¹œêµ¬ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      };
      
      const fetchUnreadMessages = async (userId) => {
        try {
          const { count } = await supabase
            .from('messages')
            .select('*', { count: 'exact', head: true })
            .eq('receiver_id', userId)
            .eq('is_read', false);
          
          const newCount = count || 0;
          // ì´ì „ë³´ë‹¤ ì¦ê°€í–ˆì„ ë•Œë§Œ ì†Œë¦¬ ì¬ìƒ
          if (newCount > prevUnreadCountRef.current) {
            playNotificationSound();
          }
          
          prevUnreadCountRef.current = newCount;
          setUnreadCount(newCount);
        } catch (error) {
          console.error('ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      };
      
      const fetchFriends = async (userEmail) => {
        try {
          const { data, error } = await supabase
            .from('friends')
            .select('*')
            .or(`user_email.eq.${userEmail},friend_email.eq.${userEmail}`);
          
          if (error) throw error;
          setFriends(data || []);
        } catch (error) {
          console.error('ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      };
      
      const fetchIdols = async () => {
        try {
          const { data, error } = await supabase
            .from('idols')
            .select('id, name, song, "videoId", votes, color, created_at')
            .order('votes', { ascending: false});
          
          if (error) throw error;
          
          // videoIdê°€ ì—†ìœ¼ë©´ videoidë¡œ ë§¤í•‘
          const mappedData = (data || []).map(idol => ({
            ...idol,
            videoId: idol.videoId || idol.videoid
          }));
          
          setVoteData(mappedData);
        } catch (error) {
          console.error('ì•„ì´ëŒ ë¡œë“œ ì‹¤íŒ¨:', error);
        } finally {
          setLoadingIdols(false);
        }
      };
      
      const fetchSchedules = async () => {
        try {
          const { data, error } = await supabase
            .from('schedules')
            .select('*')
            .order('date', { ascending: true });
          
          if (error) throw error;
          
          setSchedules(data || []);
        } catch (error) {
          console.error('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì‹¤íŒ¨:', error);
        } finally {
          setLoadingSchedules(false);
        }
      };
      
      const fetchPosts = async () => {
        try {
          const { data, error } = await supabase
            .from('posts')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          
          setPosts(data || []);
        } catch (error) {
          console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
        } finally {
          setLoadingPosts(false);
        }
      };

      // ë®¤ì§ë¹„ë””ì˜¤ ë°ì´í„°
      const musicVideos = [
        { id: 1, artist: 'NewJeans', title: 'How Sweet', videoId: 'Q3K0TOvTOno', views: '180M', date: '2024.05' },
        { id: 2, artist: 'aespa', title: 'Whiplash', videoId: 'jWQx2f-CErU', views: '95M', date: '2024.10' },
        { id: 3, artist: 'IVE', title: 'Baddie', videoId: 'Da4P2uT4mVc', views: '120M', date: '2023.10' },
        { id: 4, artist: 'LE SSERAFIM', title: 'CRAZY', videoId: 'n6B5gQXlB-0', views: '85M', date: '2024.08' },
        { id: 5, artist: 'SEVENTEEN', title: 'MAESTRO', videoId: 'ThI0pBAbFnk', views: '75M', date: '2024.05' },
        { id: 6, artist: 'Stray Kids', title: 'Chk Chk Boom', videoId: '0P0aQreFs8w', views: '90M', date: '2024.07' },
        { id: 7, artist: 'NMIXX', title: 'DASH', videoId: '7UecFm_bSTU', views: '45M', date: '2024.01' },
        { id: 8, artist: 'ITZY', title: 'GOLD', videoId: 'eMk_0svqsnI', views: '55M', date: '2024.10' },
      ];

      // SNS ê³„ì • ë°ì´í„°
      const snsAccounts = [
        {
          name: 'NewJeans',
          official: {
            instagram: 'newjeans_official',
            twitter: 'NewJeans_ADOR',
            youtube: '@NewJeans_official',
            tiktok: '@newjeans_official'
          },
          members: [
            { name: 'ë¯¼ì§€', instagram: 'minji_newjeans' },
            { name: 'í•˜ë‹ˆ', instagram: 'hanni_newjeans' },
            { name: 'ë‹¤ë‹ˆì—˜', instagram: 'daniellekimm' },
            { name: 'í•´ë¦°', instagram: 'haerin_newjeans' },
            { name: 'í˜œì¸', instagram: 'hyein_newjeans' }
          ]
        },
        {
          name: 'aespa',
          official: {
            instagram: 'aespa_official',
            twitter: 'aesloookipa',
            youtube: '@aespa',
            tiktok: '@aespa_official'
          },
          members: [
            { name: 'ì¹´ë¦¬ë‚˜', instagram: 'katarinabluu' },
            { name: 'ì§€ì ¤', instagram: 'gisellekim_' },
            { name: 'ìœˆí„°', instagram: 'winter.wxnter' },
            { name: 'ë‹ë‹', instagram: 'ningning_0323' }
          ]
        },
        {
          name: 'IVE',
          official: {
            instagram: 'ivestarship',
            twitter: 'IVEstarship',
            youtube: '@IVE',
            tiktok: '@ivestarship_official'
          },
          members: [
            { name: 'ì•ˆìœ ì§„', instagram: '_yujin_an' },
            { name: 'ê°€ì„', instagram: 'fallingin__fall' },
            { name: 'ë ˆì´', instagram: 'reinyourheart' },
            { name: 'ì¥ì›ì˜', instagram: 'for_everyoung10' },
            { name: 'ë¦¬ì¦ˆ', instagram: 'liz.yeyo' },
            { name: 'ì´ì„œ', instagram: 'le.seo_0' }
          ]
        },
        {
          name: 'LE SSERAFIM',
          official: {
            instagram: 'le_sserafim',
            twitter: 'le_sserafim',
            youtube: '@LESSERAFIM',
            tiktok: '@le_sserafim'
          },
          members: [
            { name: 'ì‚¬ì¿ ë¼', instagram: '39saku_chan' },
            { name: 'ê¹€ì±„ì›', instagram: '_chaechae_1' },
            { name: 'í—ˆìœ¤ì§„', instagram: 'jenaissansen' },
            { name: 'ì¹´ì¦ˆí•˜', instagram: 'kazuha__official' },
            { name: 'í™ì€ì±„', instagram: 'eunchae_lesserafim' }
          ]
        },
        {
          name: 'SEVENTEEN',
          official: {
            instagram: 'saythename_17',
            twitter: 'pledis_17',
            youtube: '@SEVENTEEN',
            tiktok: '@seventeen17_official'
          },
          members: []
        },
        {
          name: 'Stray Kids',
          official: {
            instagram: 'realstraykids',
            twitter: 'Stray_Kids',
            youtube: '@StrayKids',
            tiktok: '@jaborabangnda'
          },
          members: []
        }
      ];

      // ê²Œì‹œíŒ ì¹´í…Œê³ ë¦¬
      const categories = [
        { id: 'all', name: 'ì „ì²´' },
        { id: 'notice', name: 'ê³µì§€' },
        { id: 'news', name: 'ì†Œì‹' },
        { id: 'request', name: 'ìš”ì²­' },
        { id: 'free', name: 'ììœ ' },
        { id: 'qna', name: 'ì§ˆë¬¸ë‹µë³€' }
      ];

      const handleVote = async (id) => {
        try {
          // í˜„ì¬ íˆ¬í‘œìˆ˜ ê°€ì ¸ì˜¤ê¸°
          const idol = voteData.find(i => i.id === id);
          if (!idol) return;
          
          // Supabaseì—ì„œ íˆ¬í‘œìˆ˜ ì—…ë°ì´íŠ¸
          const { error } = await supabase
            .from('idols')
            .update({ votes: idol.votes + 1 })
            .eq('id', id);
          
          if (error) throw error;
          
          // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
          setVoteData(prev => 
            prev.map(idol => 
              idol.id === id ? { ...idol, votes: idol.votes + 1 } : idol
            ).sort((a, b) => b.votes - a.votes)
          );
        } catch (error) {
          console.error('íˆ¬í‘œ ì‹¤íŒ¨:', error);
          alert('íˆ¬í‘œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      };
      
      const handleSignUp = async (email, password, nickname) => {
        try {
          // ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸
          const { data: existingUser } = await supabase
            .from('users')
            .select('nickname')
            .eq('nickname', nickname)
            .maybeSingle();
          
          if (existingUser) {
            alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
            return;
          }
          
          // Supabase Auth íšŒì›ê°€ì… (metadataì— nickname í¬í•¨)
          const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: {
              data: { nickname }
            }
          });
          
          if (error) throw error;
          
          alert('íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          setShowAuthModal(false);
          setAuthMode('login');
        } catch (error) {
          alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + error.message);
        }
      };
      
      const handleLogin = async (email, password) => {
        try {
          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password
          });
          
          if (error) throw error;
          
          setShowAuthModal(false);
          checkUser();
        } catch (error) {
          alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
        }
      };
      
      const handleLogout = async () => {
        await supabase.auth.signOut();
        setUser(null);
      };
      
      const handleCreatePost = async (category, title, content) => {
        if (!user) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
          return;
        }
        
        try {
          const { error } = await supabase
            .from('posts')
            .insert([{
              category,
              title,
              author: user.nickname || user.email.split('@')[0],
              content,
              comments: 0,
              hot: false
            }]);
          
          if (error) throw error;
          
          setShowPostModal(false);
          fetchPosts();
        } catch (error) {
          alert('ê²Œì‹œê¸€ ì‘ì„± ì‹¤íŒ¨: ' + error.message);
        }
      };
      
      const handleSuggestIdol = async (name, song, videoId, color) => {
        if (!user) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
          return;
        }
        
        try {
          const { error } = await supabase
            .from('idol_suggestions')
            .insert([{
              name,
              song,
              "videoId": videoId,
              color,
              suggested_by: user.email,
              status: 'pending'
            }]);
          
          if (error) throw error;
          
          setShowIdolSuggestionModal(false);
          alert('ì•„ì´ëŒ ì œì•ˆì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (error) {
          alert('ì œì•ˆ ì‹¤íŒ¨: ' + error.message);
        }
      };
      
      const handleApproveIdol = async (suggestion) => {
        try {
          // idol_suggestionsì—ì„œ idolë¡œ ì´ë™
          const { error: insertError } = await supabase
            .from('idols')
            .insert([{
              name: suggestion.name,
              song: suggestion.song,
              "videoId": suggestion.videoId,
              color: suggestion.color,
              votes: 0
            }]);
          
          if (insertError) throw insertError;
          
          // ì œì•ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
          const { error: updateError } = await supabase
            .from('idol_suggestions')
            .update({ status: 'approved' })
            .eq('id', suggestion.id);
          
          if (updateError) throw updateError;
          
          alert('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
          fetchIdols();
        } catch (error) {
          alert('ìŠ¹ì¸ ì‹¤íŒ¨: ' + error.message);
        }
      };
      
      const handleRejectIdol = async (id) => {
        try {
          const { error } = await supabase
            .from('idol_suggestions')
            .update({ status: 'rejected' })
            .eq('id', id);
          
          if (error) throw error;
          
          alert('ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
        } catch (error) {
          alert('ê±°ë¶€ ì‹¤íŒ¨: ' + error.message);
        }
      };
      
      // ë©”ì‹œì§€ ì „ì†¡
      const handleSendMessage = async (receiverId, content) => {
        if (!user || !content.trim()) return;
        
        try {
          const { error } = await supabase
            .from('messages')
            .insert({
              sender_id: user.id,
              receiver_id: receiverId,
              content: content.trim(),
              is_read: false
            });
          
          if (error) throw error;
          await fetchUnreadMessages(user.id);
        } catch (error) {
          console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
          alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
        }
      };
      
      // ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬
      const handleMarkMessageAsRead = async (messageId) => {
        try {
          const { error } = await supabase
            .from('messages')
            .update({ is_read: true })
            .eq('id', messageId);
          
          if (error) throw error;
          await fetchUnreadMessages(user.id);
        } catch (error) {
          console.error('ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        }
      };
      
      // ì¹œêµ¬ ìš”ì²­
      const handleAddFriend = async (friendNickname) => {
        if (!user || !friendNickname.trim()) return;
        
        if (friendNickname === user.nickname) {
          alert('ìê¸° ìì‹ ì„ ì¹œêµ¬ë¡œ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          return;
        }
        
        try {
          // ë‹‰ë„¤ì„ìœ¼ë¡œ ì‚¬ìš©ì ì°¾ê¸°
          const { data: targetUser, error: findError } = await supabase
            .from('users')
            .select('id, nickname')
            .eq('nickname', friendNickname.trim())
            .single();
          
          if (findError || !targetUser) {
            alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤');
            return;
          }
          
          // ì´ë¯¸ ì¹œêµ¬ì¸ì§€ í™•ì¸
          const { data: existing } = await supabase
            .from('friendships')
            .select('status')
            .or(`and(user_id.eq.${user.id},friend_id.eq.${targetUser.id}),and(user_id.eq.${targetUser.id},friend_id.eq.${user.id})`)
            .maybeSingle();
          
          if (existing) {
            if (existing.status === 'accepted') {
              alert('ì´ë¯¸ ì¹œêµ¬ì…ë‹ˆë‹¤');
            } else {
              alert('ì´ë¯¸ ìš”ì²­ì„ ë³´ëƒˆê±°ë‚˜ ë°›ì•˜ìŠµë‹ˆë‹¤');
            }
            return;
          }
          
          // ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸°
          const { error } = await supabase
            .from('friendships')
            .insert({
              user_id: user.id,
              friend_id: targetUser.id,
              status: 'pending'
            });
          
          if (error) throw error;
          
          alert(`${friendNickname}ë‹˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤`);
          await fetchFriends(user.id);
        } catch (error) {
          console.error('ì¹œêµ¬ ì¶”ê°€ ì‹¤íŒ¨:', error);
          alert('ì¹œêµ¬ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
        }
      };
      
      // ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½
      const handleAcceptFriend = async (requestId, requesterId) => {
        try {
          // ìš”ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
          const { error: updateError } = await supabase
            .from('friendships')
            .update({ status: 'accepted' })
            .eq('id', requestId);
          
          if (updateError) throw updateError;
          
          // ì—­ë°©í–¥ ì¹œêµ¬ ê´€ê³„ ì¶”ê°€
          const { error: insertError } = await supabase
            .from('friendships')
            .insert({
              user_id: user.id,
              friend_id: requesterId,
              status: 'accepted'
            });
          
          if (insertError) throw insertError;
          
          alert('ì¹œêµ¬ ìš”ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤');
          await fetchFriends(user.id);
          await fetchFriendRequests(user.id);
        } catch (error) {
          console.error('ì¹œêµ¬ ìˆ˜ë½ ì‹¤íŒ¨:', error);
          alert('ì¹œêµ¬ ìˆ˜ë½ ì‹¤íŒ¨: ' + error.message);
        }
      };
      
      // ì¹œêµ¬ ìš”ì²­ ê±°ì ˆ
      const handleRejectFriend = async (requestId) => {
        try {
          const { error } = await supabase
            .from('friendships')
            .delete()
            .eq('id', requestId);
          
          if (error) throw error;
          
          alert('ì¹œêµ¬ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤');
          await fetchFriendRequests(user.id);
        } catch (error) {
          console.error('ì¹œêµ¬ ê±°ì ˆ ì‹¤íŒ¨:', error);
          alert('ì¹œêµ¬ ê±°ì ˆ ì‹¤íŒ¨: ' + error.message);
        }
      };
      
      const getTypeColor = (type) => {
        switch(type) {
          case 'broadcast': return 'bg-blue-100 text-blue-700';
          case 'concert': return 'bg-purple-100 text-purple-700';
          case 'fanmeeting': return 'bg-pink-100 text-pink-700';
          case 'fansign': return 'bg-green-100 text-green-700';
          default: return 'bg-gray-100 text-gray-700';
        }
      };

      const getCategoryColor = (category) => {
        switch(category) {
          case 'notice': return 'bg-red-100 text-red-700';
          case 'news': return 'bg-blue-100 text-blue-700';
          case 'request': return 'bg-yellow-100 text-yellow-700';
          case 'free': return 'bg-green-100 text-green-700';
          case 'qna': return 'bg-purple-100 text-purple-700';
          default: return 'bg-gray-100 text-gray-700';
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-yellow-50 via-orange-50 to-pink-50">
          {/* Header */}
          <header className="bg-gradient-to-r from-yellow-400 via-orange-400 to-pink-400 text-white shadow-lg">
            <div className="max-w-7xl mx-auto px-3 py-2 md:px-4 md:py-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-2">
                  <span className="text-xl md:text-3xl">ğŸ¥</span>
                  <h1 className="text-base md:text-xl font-bold">THE DUCK GO</h1>
                </div>
                <div className="flex items-center space-x-1.5 md:space-x-3">
                  <nav className="hidden md:flex space-x-4 text-xs font-medium">
                    <a href="#vote" className="hover:text-yellow-200 transition-colors">ë•ì‹¬íˆ¬í‘œ</a>
                    <a href="#mv" className="hover:text-yellow-200 transition-colors">ë®¤ì§ë¹„ë””ì˜¤</a>
                    <a href="#schedule" className="hover:text-yellow-200 transition-colors">ìŠ¤ì¼€ì¤„</a>
                    <a href="#sns" className="hover:text-yellow-200 transition-colors">SNS</a>
                    <a href="#board" className="hover:text-yellow-200 transition-colors">ê²Œì‹œíŒ</a>
                  </nav>
                  {user ? (
                    <div className="flex items-center space-x-2 md:space-x-3">
                      <span className="text-xs md:text-sm hidden md:inline">{user.nickname || user.email.split('@')[0]}</span>
                      
                      {/* ì¹œêµ¬ ì•„ì´ì½˜ */}
                      <button 
                        onClick={() => setShowFriends(true)}
                        className="relative p-1.5 md:p-2 hover:bg-white/20 rounded-lg transition-colors"
                        title="ì¹œêµ¬"
                      >
                        <Users className="w-4 h-4 md:w-5 md:h-5" />
                      </button>
                      
                      {/* ì•Œë¦¼ ì•„ì´ì½˜ */}
                      <button 
                        onClick={() => setShowNotifications(true)}
                        className="relative p-1.5 md:p-2 hover:bg-white/20 rounded-lg transition-colors"
                        title="ì•Œë¦¼"
                      >
                        <Bell className="w-4 h-4 md:w-5 md:h-5" />
                        {notificationCount > 0 && (
                          <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                            {notificationCount}
                          </span>
                        )}
                      </button>
                      
                      {/* ë©”ì‹œì§€ ì•„ì´ì½˜ */}
                      <button 
                        onClick={() => setShowMessenger(true)}
                        className="relative p-2 hover:bg-white/20 rounded-lg transition-colors"
                        title="ë©”ì‹œì§€"
                      >
                        <MessageSquare className="w-5 h-5" />
                        {unreadCount > 0 && (
                          <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                            {unreadCount}
                          </span>
                        )}
                      </button>
                      
                      <div className="flex flex-col space-y-0.5">
                        <button onClick={() => setShowAdminPage(true)} className="text-[10px] md:text-xs px-2 py-0.5 bg-purple-600 rounded hover:bg-purple-700 transition-colors whitespace-nowrap">
                          ê´€ë¦¬ì
                        </button>
                        <button onClick={handleLogout} className="text-[10px] md:text-xs px-2 py-0.5 bg-white/20 rounded hover:bg-white/30 transition-colors whitespace-nowrap">
                          ë¡œê·¸ì•„ì›ƒ
                        </button>
                      </div>
                    </div>
                  ) : (
                    <button onClick={() => { setAuthMode('login'); setShowAuthModal(true); }} className="text-xs px-3 py-1 bg-white/20 rounded hover:bg-white/30 transition-colors">
                      ë¡œê·¸ì¸
                    </button>
                  )}
                </div>
              </div>
            </div>
          </header>

          {/* Hero Banner */}
          <section className="bg-gradient-to-r from-amber-500 via-orange-500 to-rose-500 text-white py-3 md:py-6">
            <div className="max-w-7xl mx-auto px-3 md:px-4 text-center">
              <h2 className="text-base md:text-2xl font-bold mb-1">ğŸ¥ ë•ì˜, ë•ì— ì˜í•œ, ë•ì„ ìœ„í•œ</h2>
              <p className="text-xs md:text-base opacity-90 mb-1">K-POP ì•„ì´ëŒ ë•í›„ë“¤ì˜ ë†€ì´í„°</p>
              <p className="text-[10px] md:text-sm opacity-75">
                "ë•(Duck)"ì€ ì˜¤ë¦¬, "ë•(Deok)"ì€ ë•í›„! ì˜¤ë¦¬ì²˜ëŸ¼ ë¬¼ ìœ„ì—ì„œëŠ” ìš°ì•„í•˜ê²Œ, ë¬¼ ë°‘ì—ì„œëŠ” ì—´ì‹¬íˆ ë•ì§ˆí•˜ëŠ” ìš°ë¦¬ë“¤ì˜ ê³µê°„
              </p>
            </div>
          </section>

          <main className="max-w-7xl mx-auto px-3 md:px-4 py-3 md:py-6">
            {/* ë•ì‹¬íˆ¬í‘œ ì„¹ì…˜ */}
            <section id="vote" className="mb-6 md:mb-8">
              <div className="flex items-center justify-between mb-3 md:mb-4">
                <div className="flex items-center space-x-2">
                  <h2 className="text-base md:text-xl font-bold text-gray-800 flex items-center whitespace-nowrap">
                    <TrendingUp className="w-4 h-4 md:w-6 md:h-6 mr-1 md:mr-2 text-orange-500" />
                    ğŸ”¥ ì‹¤ì‹œê°„ ë•ì‹¬íˆ¬í‘œ
                  </h2>
                  {resetDate && (
                    <p className="text-[10px] md:text-xs text-gray-500 whitespace-nowrap">
                      ğŸ“… {resetDate} íˆ¬í‘œ
                    </p>
                  )}
                </div>
                <div className="flex items-center space-x-2">
                  <span className="text-xs md:text-sm text-gray-500 hidden sm:inline">
                    ì´ {voteData.reduce((sum, i) => sum + i.votes, 0).toLocaleString()}í‘œ
                  </span>
                  {user && (
                    <button 
                      onClick={() => setShowIdolSuggestionModal(true)}
                      className="px-2 py-1 md:px-4 md:py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs md:text-sm rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all whitespace-nowrap"
                    >
                      â• ì•„ì´ëŒ ì œì•ˆ
                    </button>
                  )}
                </div>
              </div>
              
              {loadingIdols ? (
                <div className="text-center py-12 text-gray-500">
                  <div className="animate-pulse">ì•„ì´ëŒ ë¡œë”© ì¤‘...</div>
                </div>
              ) : voteData.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  ì•„ì§ ë“±ë¡ëœ ì•„ì´ëŒì´ ì—†ìŠµë‹ˆë‹¤
                </div>
              ) : (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                  {voteData.map((idol, index) => {
                  const maxVotes = Math.max(...voteData.map(i => i.votes), 1);
                  return (
                  <div
                    key={idol.id}
                    onClick={() => handleVote(idol.id)}
                    className="relative overflow-hidden rounded-xl shadow-lg cursor-pointer transform hover:scale-105 transition-all duration-300 group"
                    style={{ aspectRatio: '3/4' }}
                  >
                    {/* ìœ íŠœë¸Œ ì¸ë„¤ì¼ ë°°ê²½ */}
                    <div 
                      className="absolute inset-0 bg-cover bg-center"
                      style={{ 
                        backgroundImage: `url(https://img.youtube.com/vi/${idol.videoId}/maxresdefault.jpg)` 
                      }}
                    />
                    
                    {/* ê·¸ë¼ë°ì´ì…˜ ì˜¤ë²„ë ˆì´ */}
                    <div className={`absolute inset-0 bg-gradient-to-t ${idol.color} opacity-60 group-hover:opacity-40 transition-opacity`} />
                    <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent" />
                    
                    {/* ìˆœìœ„ ë±ƒì§€ */}
                    <div className="absolute top-2 left-2 w-8 h-8 bg-white/90 rounded-full flex items-center justify-center font-bold text-gray-800 shadow">
                      {index + 1}
                    </div>
                    
                    {/* ì»¨í…ì¸  */}
                    <div className="absolute bottom-0 left-0 right-0 p-3 text-white">
                      <h3 className="font-bold text-sm truncate">{idol.name}</h3>
                      <p className="text-xs opacity-80 truncate">{idol.song}</p>
                      <div className="mt-2">
                        <div className="flex items-center justify-between text-xs mb-1">
                          <span className="flex items-center">
                            <Heart className="w-3 h-3 mr-1 fill-current" />
                            {idol.votes.toLocaleString()}
                          </span>
                        </div>
                        <div className="h-1.5 bg-white/30 rounded-full overflow-hidden">
                          <div 
                            className="h-full bg-white rounded-full transition-all duration-500"
                            style={{ width: `${(idol.votes / maxVotes) * 100}%` }}
                          />
                        </div>
                      </div>
                    </div>
                    
                    {/* í˜¸ë²„ íš¨ê³¼ */}
                    <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                      <div className="bg-white/90 rounded-full p-3 shadow-lg">
                        <Heart className="w-6 h-6 text-pink-500" />
                      </div>
                    </div>
                  </div>
                  );
                  })}
                </div>
              )}
            </section>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* ì™¼ìª½ ì»¬ëŸ¼ - ë®¤ì§ë¹„ë””ì˜¤ */}
              <div className="lg:col-span-2 space-y-6">
                {/* ë®¤ì§ë¹„ë””ì˜¤ ì„¹ì…˜ */}
                <section id="mv" className="bg-white rounded-xl shadow-md p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <Play className="w-6 h-6 mr-2 text-red-500" />
                    ê³µì‹ ë®¤ì§ë¹„ë””ì˜¤
                  </h2>
                  <p className="text-sm text-gray-600 mb-4">ğŸ¬ í´ë¦­í•˜ë©´ ì˜ìƒì´ ì¬ìƒë©ë‹ˆë‹¤</p>
                  
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                    {musicVideos.map((video) => (
                      <div 
                        key={video.id}
                        onClick={() => setSelectedVideo(video)}
                        className="group cursor-pointer"
                      >
                        <div className="relative aspect-video rounded-lg overflow-hidden mb-2 shadow-sm group-hover:shadow-md transition-shadow">
                          <img 
                            src={`https://img.youtube.com/vi/${video.videoId}/mqdefault.jpg`}
                            alt={`${video.artist} - ${video.title}`}
                            className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                          />
                          <div className="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-colors flex items-center justify-center">
                            <Play className="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="white" />
                          </div>
                          <div className="absolute bottom-1 right-1 bg-black/70 text-white text-xs px-1 rounded">
                            {video.views}
                          </div>
                        </div>
                        <h3 className="text-xs font-medium text-gray-800 truncate">{video.artist}</h3>
                        <p className="text-xs text-gray-500 truncate">{video.title}</p>
                      </div>
                    ))}
                  </div>
                </section>

                {/* ê²Œì‹œíŒ ì„¹ì…˜ */}
                <section id="board" className="bg-white rounded-xl shadow-md p-6">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-xl font-bold text-gray-800 flex items-center">
                      <MessageSquare className="w-6 h-6 mr-2 text-green-600" />
                      ì»¤ë®¤ë‹ˆí‹°
                    </h2>
                    {user ? (
                      <button 
                        onClick={() => setShowPostModal(true)}
                        className="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors"
                      >
                        âœï¸ ê¸€ì“°ê¸°
                      </button>
                    ) : (
                      <button 
                        onClick={() => { setAuthMode('login'); setShowAuthModal(true); }}
                        className="px-4 py-2 bg-gray-300 text-gray-600 text-sm rounded-lg hover:bg-gray-400 transition-colors"
                      >
                        ğŸ”’ ë¡œê·¸ì¸ í•„ìš”
                      </button>
                    )}
                  </div>
                  
                  {/* ì¹´í…Œê³ ë¦¬ íƒ­ */}
                  <div className="flex flex-wrap gap-2 mb-4">
                    {categories.map((cat) => (
                      <button
                        key={cat.id}
                        onClick={() => setActiveCategory(cat.id)}
                        className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${
                          activeCategory === cat.id 
                            ? 'bg-orange-500 text-white' 
                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                        }`}
                      >
                        {cat.name}
                      </button>
                    ))}
                  </div>
                  
                  {/* ê²Œì‹œê¸€ ëª©ë¡ */}
                  {loadingPosts ? (
                    <div className="text-center py-8 text-gray-500">
                      <div className="animate-pulse">ê²Œì‹œê¸€ ë¡œë”© ì¤‘...</div>
                    </div>
                  ) : posts.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      ì²« ê²Œì‹œê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {posts
                        .filter(post => activeCategory === 'all' || post.category === activeCategory)
                        .map((post) => (
                          <div 
                            key={post.id}
                            onClick={() => setSelectedPost(post)}
                            className="flex items-center justify-between py-2 px-3 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer"
                          >
                            <div className="flex items-center space-x-3 flex-1 min-w-0">
                              <span className={`text-xs px-2 py-0.5 rounded ${getCategoryColor(post.category)}`}>
                                {categories.find(c => c.id === post.category)?.name}
                              </span>
                              <span className="text-sm text-gray-800 truncate flex items-center">
                                {post.hot && <span className="text-red-500 mr-1">ğŸ”¥</span>}
                                {post.title}
                              </span>
                            </div>
                            <div className="flex items-center space-x-3 text-xs text-gray-500 ml-2">
                              <span>{post.author}</span>
                              <span className="flex items-center">
                                <MessageSquare className="w-3 h-3 mr-1" />
                                {post.comments}
                              </span>
                              <span>{new Date(post.created_at).toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit' })}</span>
                            </div>
                          </div>
                        ))}
                    </div>
                  )}
                </section>
              </div>

              {/* ì˜¤ë¥¸ìª½ ì»¬ëŸ¼ */}
              <div className="space-y-6">
                {/* ìŠ¤ì¼€ì¤„ ì„¹ì…˜ */}
                <section id="schedule" className="bg-white rounded-xl shadow-md p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <Calendar className="w-6 h-6 mr-2 text-blue-600" />
                    ì´ë²ˆì£¼ ìŠ¤ì¼€ì¤„
                  </h2>
                  <p className="text-sm text-gray-600 mb-4">ğŸ“… ë†“ì¹˜ë©´ ì•ˆë  ì¼ì •! (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)</p>
                  
                  {loadingSchedules ? (
                    <div className="text-center py-8 text-gray-500">
                      <div className="animate-pulse">ìŠ¤ì¼€ì¤„ ë¡œë”© ì¤‘...</div>
                    </div>
                  ) : schedules.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      ë“±ë¡ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {schedules.map((schedule, index) => (
                        <div key={schedule.id || index} className="border-l-4 border-purple-500 pl-3 py-2 hover:bg-gray-50 rounded-r-lg transition-colors">
                          <div className="flex items-center justify-between mb-1">
                            <span className="text-sm font-bold text-purple-600">{schedule.date}</span>
                            <span className={`text-xs px-2 py-0.5 rounded-full ${getTypeColor(schedule.type)}`}>
                              {schedule.type === 'broadcast' ? 'ë°©ì†¡' : 
                               schedule.type === 'concert' ? 'ì½˜ì„œíŠ¸' : 
                               schedule.type === 'fanmeeting' ? 'íŒ¬ë¯¸íŒ…' : 'ì‚¬ì¸íšŒ'}
                            </span>
                          </div>
                          <p className="text-sm font-medium text-gray-800">{schedule.event}</p>
                          {schedule.artist && (
                            <p className="text-xs text-purple-600 font-medium">{schedule.artist}</p>
                          )}
                          <p className="text-xs text-gray-500">{schedule.time} Â· {schedule.location}</p>
                        </div>
                      ))}
                    </div>
                  )}
                </section>

                {/* SNS ê³„ì • ëª¨ìŒ ì„¹ì…˜ */}
                <section id="sns" className="bg-white rounded-xl shadow-md p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <Instagram className="w-6 h-6 mr-2 text-pink-500" />
                    SNS ê³„ì • ëª¨ìŒ
                  </h2>
                  <p className="text-sm text-gray-600 mb-4">ğŸ“± ê³µì‹ & ë©¤ë²„ ê³„ì •</p>
                  
                  <div className="space-y-4 max-h-96 overflow-y-auto">
                    {snsAccounts.map((group, index) => (
                      <div key={index} className="border-b border-gray-100 pb-3 last:border-0">
                        <h3 className="font-bold text-sm text-gray-800 mb-2">{group.name}</h3>
                        
                        {/* ê³µì‹ ê³„ì • */}
                        <div className="flex flex-wrap gap-1 mb-2">
                          <a href={`https://instagram.com/${group.official.instagram}`} target="_blank" rel="noopener noreferrer" 
                             className="inline-flex items-center px-2 py-0.5 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs rounded hover:opacity-80 transition-opacity">
                            <Instagram className="w-3 h-3 mr-1" />
                            ê³µì‹
                          </a>
                          <a href={`https://twitter.com/${group.official.twitter}`} target="_blank" rel="noopener noreferrer"
                             className="inline-flex items-center px-2 py-0.5 bg-black text-white text-xs rounded hover:opacity-80 transition-opacity">
                            <Twitter className="w-3 h-3 mr-1" />
                            X
                          </a>
                          <a href={`https://youtube.com/${group.official.youtube}`} target="_blank" rel="noopener noreferrer"
                             className="inline-flex items-center px-2 py-0.5 bg-red-600 text-white text-xs rounded hover:opacity-80 transition-opacity">
                            <Youtube className="w-3 h-3 mr-1" />
                            YT
                          </a>
                          <a href={`https://tiktok.com/${group.official.tiktok}`} target="_blank" rel="noopener noreferrer"
                             className="inline-flex items-center px-2 py-0.5 bg-gray-900 text-white text-xs rounded hover:opacity-80 transition-opacity">
                            <Music className="w-3 h-3 mr-1" />
                            TT
                          </a>
                        </div>
                        
                        {/* ë©¤ë²„ ê³„ì • */}
                        {group.members.length > 0 && (
                          <div className="flex flex-wrap gap-1">
                            {group.members.map((member, mIndex) => (
                              <a 
                                key={mIndex}
                                href={`https://instagram.com/${member.instagram}`} 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="inline-flex items-center px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded hover:bg-pink-100 hover:text-pink-600 transition-colors"
                              >
                                {member.name}
                              </a>
                            ))}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </section>
              </div>
            </div>
          </main>

          {/* Footer */}
          <footer className="bg-gray-800 text-white py-6 mt-8">
            <div className="max-w-7xl mx-auto px-4 text-center">
              <div className="flex items-center justify-center space-x-2 mb-2">
                <span className="text-2xl">ğŸ¥</span>
                <span className="font-bold">THE DUCK GO</span>
              </div>
              <p className="text-sm text-gray-400">Of the Deok, By the Deok, For the Deok</p>
              <p className="text-xs text-gray-500 mt-2">Â© 2024 TheDuckGo. All rights reserved.</p>
            </div>
          </footer>

          {/* ë¹„ë””ì˜¤ ëª¨ë‹¬ */}
          {selectedVideo && (
            <div 
              className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"
              onClick={() => setSelectedVideo(null)}
            >
              <div 
                className="bg-black rounded-xl overflow-hidden max-w-4xl w-full"
                onClick={e => e.stopPropagation()}
              >
                <div className="flex items-center justify-between p-3 bg-gray-900">
                  <div>
                    <h3 className="font-bold text-white">{selectedVideo.artist}</h3>
                    <p className="text-sm text-gray-400">{selectedVideo.title}</p>
                  </div>
                  <button 
                    onClick={() => setSelectedVideo(null)}
                    className="text-gray-400 hover:text-white transition-colors"
                  >
                    <X className="w-6 h-6" />
                  </button>
                </div>
                <div className="aspect-video">
                  <iframe
                    width="100%"
                    height="100%"
                    src={`https://www.youtube.com/embed/${selectedVideo.videoId}?autoplay=1&rel=0&modestbranding=1`}
                    title={`${selectedVideo.artist} - ${selectedVideo.title}`}
                    frameBorder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowFullScreen
                    referrerPolicy="strict-origin-when-cross-origin"
                  />
                </div>
              </div>
            </div>
          )}
          
          {/* ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ */}
          {showAuthModal && (
            <AuthModal 
              mode={authMode}
              onClose={() => setShowAuthModal(false)}
              onLogin={handleLogin}
              onSignUp={handleSignUp}
              setMode={setAuthMode}
            />
          )}
          
          {/* ê¸€ì“°ê¸° ëª¨ë‹¬ */}
          {showPostModal && (
            <PostModal 
              onClose={() => setShowPostModal(false)}
              onCreate={handleCreatePost}
              categories={categories.filter(c => c.id !== 'all')}
            />
          )}
          
          {/* ì•„ì´ëŒ ì œì•ˆ ëª¨ë‹¬ */}
          {showIdolSuggestionModal && (
            <IdolSuggestionModal 
              onClose={() => setShowIdolSuggestionModal(false)}
              onSuggest={handleSuggestIdol}
            />
          )}
          
          {/* ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ */}
          {selectedPost && (
            <PostDetailModal 
              post={selectedPost}
              onClose={() => setSelectedPost(null)}
            />
          )}
          
          {/* ë©”ì‹ ì € ëª¨ë‹¬ */}
          {showMessenger && user && (
            <MessengerModal 
              user={user}
              onClose={() => setShowMessenger(false)}
              onSendMessage={handleSendMessage}
              onMarkAsRead={() => fetchUnreadMessages(user.id)}
            />
          )}
          
          {/* ì¹œêµ¬ ìš”ì²­ ì•Œë¦¼ ëª¨ë‹¬ */}
          {showNotifications && user && (
            <FriendRequestsModal 
              onClose={() => setShowNotifications(false)}
              friendRequests={friendRequests}
              onAccept={(requestId, requesterId) => {
                handleAcceptFriend(requestId, requesterId);
              }}
              onReject={(requestId) => {
                handleRejectFriend(requestId);
              }}
            />
          )}
          
          {/* ì¹œêµ¬ ëª¨ë‹¬ */}
          {showFriends && user && (
            <FriendsModal 
              user={user}
              onClose={() => setShowFriends(false)}
              friends={friends}
              onAddFriend={handleAddFriend}
              onAccept={handleAcceptFriend}
              onReject={handleRejectFriend}
            />
          )}
          
          {/* ê´€ë¦¬ì í˜ì´ì§€ */}
          {showAdminPage && (
            <AdminPage 
              onClose={() => setShowAdminPage(false)}
              onApprove={handleApproveIdol}
              onReject={handleRejectIdol}
            />
          )}
        </div>
      );
    }
    
    // ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
    function AuthModal({ mode, onClose, onLogin, onSignUp, setMode }) {
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [nickname, setNickname] = React.useState('');
      
      const handleSubmit = (e) => {
        e.preventDefault();
        if (mode === 'login') {
          onLogin(email, password);
        } else {
          onSignUp(email, password, nickname);
        }
      };
      
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-white rounded-xl p-6 max-w-md w-full" onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold">{mode === 'login' ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…'}</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                  required
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                  required
                  minLength="6"
                />
              </div>
              
              {mode === 'signup' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ë‹‰ë„¤ì„</label>
                  <input
                    type="text"
                    value={nickname}
                    onChange={(e) => setNickname(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    required
                  />
                </div>
              )}
              
              <button
                type="submit"
                className="w-full py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors font-medium"
              >
                {mode === 'login' ? 'ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…'}
              </button>
            </form>
            
            <div className="mt-4 text-center">
              <button
                onClick={() => setMode(mode === 'login' ? 'signup' : 'login')}
                className="text-sm text-orange-500 hover:underline"
              >
                {mode === 'login' ? 'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…' : 'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸'}
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // ê¸€ì“°ê¸° ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
    function PostModal({ onClose, onCreate, categories }) {
      const [category, setCategory] = React.useState('free');
      const [title, setTitle] = React.useState('');
      const [content, setContent] = React.useState('');
      
      const handleSubmit = (e) => {
        e.preventDefault();
        onCreate(category, title, content);
      };
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-white rounded-xl p-6 max-w-2xl w-full" onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold">ìƒˆ ê²Œì‹œê¸€ ì‘ì„±</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ì¹´í…Œê³ ë¦¬</label>
                <select
                  value={category}
                  onChange={(e) => setCategory(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                >
                  {categories.map(cat => (
                    <option key={cat.id} value={cat.id}>{cat.name}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
                <input
                  type="text"
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                  required
                  placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ë‚´ìš©</label>
                <textarea
                  value={content}
                  onChange={(e) => setContent(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                  rows="6"
                  required
                  placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>
              
              <button
                type="submit"
                className="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
              >
                ì‘ì„± ì™„ë£Œ
              </button>
            </form>
          </div>
        </div>
      );
    }
    
    // ì•„ì´ëŒ ì œì•ˆ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
    function IdolSuggestionModal({ onClose, onSuggest }) {
      const [name, setName] = React.useState('');
      const [song, setSong] = React.useState('');
      const [videoId, setVideoId] = React.useState('');
      const [color, setColor] = React.useState('from-purple-500 to-pink-500');
      
      const handleSubmit = (e) => {
        e.preventDefault();
        onSuggest(name, song, videoId, color);
      };
      
      const colorOptions = [
        { value: 'from-blue-400 to-cyan-300', label: 'íŒŒë‘-ì²­ë¡' },
        { value: 'from-purple-500 to-pink-400', label: 'ë³´ë¼-ë¶„í™' },
        { value: 'from-pink-500 to-rose-400', label: 'ë¶„í™-ì¥ë¯¸' },
        { value: 'from-red-500 to-orange-400', label: 'ë¹¨ê°•-ì£¼í™©' },
        { value: 'from-yellow-500 to-red-500', label: 'ë…¸ë‘-ë¹¨ê°•' },
        { value: 'from-green-400 to-emerald-500', label: 'ì´ˆë¡-ì—ë©”ë„ë“œ' }
      ];
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-white rounded-xl p-6 max-w-lg w-full" onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold">ìƒˆ ì•„ì´ëŒ ì œì•ˆ</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ì•„ì´ëŒ/ê·¸ë£¹ëª…</label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  required
                  placeholder="ì˜ˆ: NewJeans"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ëŒ€í‘œê³¡</label>
                <input
                  type="text"
                  value={song}
                  onChange={(e) => setSong(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  required
                  placeholder="ì˜ˆ: How Sweet"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">YouTube Video ID</label>
                <input
                  type="text"
                  value={videoId}
                  onChange={(e) => setVideoId(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  required
                  placeholder="ì˜ˆ: Q3K0TOvTOno"
                />
                <p className="text-xs text-gray-500 mt-1">
                  ìœ íŠœë¸Œ URLì˜ v= ë’¤ì˜ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”
                </p>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ë°°ê²½ ìƒ‰ìƒ</label>
                <select
                  value={color}
                  onChange={(e) => setColor(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                >
                  {colorOptions.map(opt => (
                    <option key={opt.value} value={opt.value}>{opt.label}</option>
                  ))}
                </select>
              </div>
              
              <button
                type="submit"
                className="w-full py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-colors font-medium"
              >
                ì œì•ˆí•˜ê¸°
              </button>
            </form>
          </div>
        </div>
      );
    }
    
    // ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
    function PostDetailModal({ post, onClose }) {
      const getCategoryColor = (category) => {
        const colors = {
          notice: 'bg-red-100 text-red-600',
          news: 'bg-blue-100 text-blue-600',
          request: 'bg-green-100 text-green-600',
          free: 'bg-gray-100 text-gray-600',
          qna: 'bg-purple-100 text-purple-600'
        };
        return colors[category] || 'bg-gray-100 text-gray-600';
      };
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center space-x-3">
                <span className={`text-xs px-2 py-1 rounded ${getCategoryColor(post.category)}`}>
                  {post.category === 'notice' ? 'ê³µì§€' :
                   post.category === 'news' ? 'ì†Œì‹' :
                   post.category === 'request' ? 'ìš”ì²­' :
                   post.category === 'free' ? 'ììœ ' : 'ì§ˆë¬¸ë‹µë³€'}
                </span>
                {post.hot && <span className="text-red-500">ğŸ”¥ HOT</span>}
              </div>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <h2 className="text-2xl font-bold text-gray-800 mb-4">{post.title}</h2>
            
            <div className="flex items-center justify-between text-sm text-gray-500 border-b pb-3 mb-6">
              <div className="flex items-center space-x-4">
                <span className="font-medium">{post.author}</span>
                <span>{new Date(post.created_at).toLocaleString('ko-KR', { 
                  year: 'numeric', 
                  month: '2-digit', 
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit'
                })}</span>
              </div>
              <div className="flex items-center space-x-3">
                <span className="flex items-center">
                  <Eye className="w-4 h-4 mr-1" />
                  {post.views || 0}
                </span>
                <span className="flex items-center">
                  <MessageSquare className="w-4 h-4 mr-1" />
                  {post.comments}
                </span>
              </div>
            </div>
            
            <div className="prose max-w-none">
              <p className="text-gray-700 whitespace-pre-wrap leading-relaxed">{post.content}</p>
            </div>
            
            <div className="mt-6 pt-4 border-t">
              <button 
                onClick={onClose}
                className="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
              >
                ë‹«ê¸°
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // ë©”ì‹ ì € ëª¨ë‹¬
    function MessengerModal({ user, onClose, onSendMessage, onMarkAsRead }) {
      const [selectedFriend, setSelectedFriend] = React.useState(null);
      const [messageText, setMessageText] = React.useState('');
      const [friends, setFriends] = React.useState([]);
      const [messages, setMessages] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const messagesEndRef = React.useRef(null);
      const [attachedFile, setAttachedFile] = React.useState(null);
      const [isRecording, setIsRecording] = React.useState(false);
      const [mediaRecorder, setMediaRecorder] = React.useState(null);
      const fileInputRef = React.useRef(null);
      
      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };
      
      React.useEffect(() => {
        scrollToBottom();
      }, [messages]);
      
      React.useEffect(() => {
        loadFriends();
      }, []);
      
      React.useEffect(() => {
        if (selectedFriend) {
          loadMessages(selectedFriend.id);
          
          // 2ì´ˆë§ˆë‹¤ ë©”ì‹œì§€ ìë™ ìƒˆë¡œê³ ì¹¨
          const interval = setInterval(() => {
            loadMessages(selectedFriend.id);
          }, 2000);
          
          return () => clearInterval(interval);
        }
      }, [selectedFriend]);
      
      const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
          setAttachedFile(file);
        }
      };
      
      const handleRemoveFile = () => {
        setAttachedFile(null);
        if (fileInputRef.current) {
          fileInputRef.current.value = '';
        }
      };
      
      const startRecording = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const recorder = new MediaRecorder(stream);
          const chunks = [];
          
          recorder.ondataavailable = (e) => chunks.push(e.data);
          recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const file = new File([blob], `recording-${Date.now()}.webm`, { type: 'audio/webm' });
            setAttachedFile(file);
            stream.getTracks().forEach(track => track.stop());
          };
          
          recorder.start();
          setMediaRecorder(recorder);
          setIsRecording(true);
        } catch (error) {
          alert('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤');
        }
      };
      
      const stopRecording = () => {
        if (mediaRecorder && isRecording) {
          mediaRecorder.stop();
          setIsRecording(false);
        }
      };
      
      const uploadFile = async (file) => {
        try {
          const fileName = `${Date.now()}-${file.name}`;
          const { data, error } = await supabase.storage
            .from('message-files')
            .upload(fileName, file);
          
          if (error) {
            console.error('Storage ì—…ë¡œë“œ ì—ëŸ¬:', error);
            alert('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: Supabase Storage ë²„í‚· "message-files"ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n\nStorage â†’ New Bucket â†’ ì´ë¦„: message-files (Public)');
            throw error;
          }
          
          const { data: urlData } = supabase.storage
            .from('message-files')
            .getPublicUrl(fileName);
          
          return urlData.publicUrl;
        } catch (error) {
          console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
          throw error;
        }
      };
      
      const loadFriends = async () => {
        try {
          const { data, error } = await supabase
            .from('friendships')
            .select(`
              friend_id,
              users!friendships_friend_id_fkey(id, nickname, email)
            `)
            .eq('user_id', user.id)
            .eq('status', 'accepted');
          
          if (error) throw error;
          setFriends((data || []).map(f => f.users));
        } catch (error) {
          console.error('ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        } finally {
          setLoading(false);
        }
      };
      
      React.useEffect(() => {
        if (selectedFriend) {
          loadMessages(selectedFriend.id);
        }
      }, [selectedFriend]);
      
      const loadMessages = async (friendId) => {
        try {
          const { data, error } = await supabase
            .from('messages')
            .select('*')
            .or(`and(sender_id.eq.${user.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${user.id})`)
            .order('created_at', { ascending: true });
          
          if (error) throw error;
          setMessages(data || []);
          
          const unreadMessages = data?.filter(m => m.receiver_id === user.id && !m.is_read);
          if (unreadMessages && unreadMessages.length > 0) {
            for (const msg of unreadMessages) {
              await supabase
                .from('messages')
                .update({ is_read: true })
                .eq('id', msg.id);
            }
            // ì½ìŒ ì²˜ë¦¬ í›„ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            if (onMarkAsRead) {
              await onMarkAsRead();
            }
          }
        } catch (error) {
          console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      };
      
      const handleSend = async () => {
        if (!selectedFriend) return;
        if (!messageText.trim() && !attachedFile) return;
        
        try {
          let fileUrl = null;
          let fileType = null;
          
          if (attachedFile) {
            try {
              fileUrl = await uploadFile(attachedFile);
              fileType = attachedFile.type.startsWith('image/') ? 'image' :
                        attachedFile.type.startsWith('audio/') ? 'audio' :
                        attachedFile.type.startsWith('video/') ? 'video' : 'file';
            } catch (uploadError) {
              console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', uploadError);
              if (!messageText.trim()) {
                alert('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨. í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ Supabase Storageë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
              }
              // í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ íŒŒì¼ ì—†ì´ ì „ì†¡
            }
          }
          
          const { error } = await supabase
            .from('messages')
            .insert({
              sender_id: user.id,
              receiver_id: selectedFriend.id,
              content: messageText.trim() || (fileUrl ? `[${fileType}]` : ''),
              file_url: fileUrl,
              file_type: fileType,
              is_read: false
            });
          
          if (error) throw error;
          
          setMessageText('');
          setAttachedFile(null);
          if (fileInputRef.current) {
            fileInputRef.current.value = '';
          }
          await loadMessages(selectedFriend.id);
        } catch (error) {
          console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
          alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
        }
      };
      
      return (
        <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-white/70 backdrop-blur-lg rounded-xl w-full max-w-4xl h-[600px] flex flex-col md:flex-row shadow-2xl border border-white/20" onClick={(e) => e.stopPropagation()}>
            {/* ì¹œêµ¬ ëª©ë¡ */}
            <div className="w-full md:w-1/3 border-b md:border-b-0 md:border-r flex flex-col max-h-[200px] md:max-h-full">
              <div className="p-4 border-b flex items-center justify-between">
                <h2 className="font-bold">ë©”ì‹œì§€</h2>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 md:hidden">
                  <X className="w-5 h-5" />
                </button>
              </div>
              <div className="flex-1 overflow-y-auto">
                {loading ? (
                  <div className="text-center py-8 text-gray-500 text-sm">ë¡œë”© ì¤‘...</div>
                ) : friends.length === 0 ? (
                  <div className="text-center py-8 text-gray-500 text-sm">ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                ) : (
                  friends.map((friend) => (
                    <div
                      key={friend.id}
                      onClick={() => setSelectedFriend(friend)}
                      className={`p-3 border-b cursor-pointer hover:bg-white/50 ${selectedFriend?.id === friend.id ? 'bg-blue-100/50' : ''}`}
                    >
                      <div className="font-medium text-sm">{friend.nickname}</div>
                      <div className="text-xs text-gray-500 truncate">{friend.email}</div>
                    </div>
                  ))
                )}
              </div>
            </div>
            
            {/* ì±„íŒ…ì°½ */}
            <div className="flex-1 flex flex-col min-h-0">
              {selectedFriend ? (
                <>
                  <div className="p-3 border-b flex items-center justify-between">
                    <div className="font-bold text-sm">{selectedFriend.nickname}</div>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600 hidden md:block">
                      <X className="w-5 h-5" />
                    </button>
                  </div>
                  <div className="flex-1 overflow-y-auto p-3 space-y-2">
                    {messages.map((msg) => (
                      <div key={msg.id} className={`flex ${msg.sender_id === user.id ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[70%] px-3 py-2 rounded-lg text-sm ${msg.sender_id === user.id ? 'bg-blue-500/90 text-white' : 'bg-white/80'}`}>
                          {msg.file_url && msg.file_type === 'image' && (
                            <img src={msg.file_url} alt="ì²¨ë¶€ ì´ë¯¸ì§€" className="rounded mb-2 max-w-full" />
                          )}
                          {msg.file_url && msg.file_type === 'audio' && (
                            <audio controls className="mb-2 max-w-full">
                              <source src={msg.file_url} type="audio/webm" />
                            </audio>
                          )}
                          {msg.file_url && msg.file_type === 'file' && (
                            <a href={msg.file_url} target="_blank" className="block mb-2 underline text-xs">
                              ğŸ“ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                            </a>
                          )}
                          {msg.content && <div>{msg.content}</div>}
                          <div className="text-xs opacity-70 mt-1">
                            {new Date(msg.created_at).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}
                          </div>
                        </div>
                      </div>
                    ))}
                    <div ref={messagesEndRef} />
                  </div>
                  <div className="p-3 border-t bg-white/50">
                    {attachedFile && (
                      <div className="mb-2 flex items-center justify-between bg-blue-50 p-2 rounded">
                        <span className="text-xs truncate flex-1">
                          {attachedFile.type.startsWith('image/') ? 'ğŸ–¼ï¸' : 
                           attachedFile.type.startsWith('audio/') ? 'ğŸ¤' : 'ğŸ“'} {attachedFile.name}
                        </span>
                        <button onClick={handleRemoveFile} className="text-red-500 ml-2 text-sm">âœ•</button>
                      </div>
                    )}
                    <div className="flex items-end space-x-1">
                      <input
                        ref={fileInputRef}
                        type="file"
                        onChange={handleFileSelect}
                        className="hidden"
                        accept="image/*,audio/*,video/*,.pdf,.doc,.docx"
                      />
                      <button 
                        onClick={() => fileInputRef.current?.click()}
                        className="flex-shrink-0 p-2 bg-gray-100 rounded-lg hover:bg-gray-200 text-sm"
                        title="íŒŒì¼ ì²¨ë¶€"
                      >
                        ğŸ“
                      </button>
                      <button 
                        onClick={isRecording ? stopRecording : startRecording}
                        className={`flex-shrink-0 p-2 rounded-lg text-sm ${isRecording ? 'bg-red-500 text-white animate-pulse' : 'bg-gray-100 hover:bg-gray-200'}`}
                        title={isRecording ? "ë…¹ìŒ ì¤‘ì§€" : "ìŒì„± ë…¹ìŒ"}
                      >
                        ğŸ¤
                      </button>
                      <input
                        type="text"
                        value={messageText}
                        onChange={(e) => setMessageText(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                        placeholder="ë©”ì‹œì§€ ì…ë ¥..."
                        className="flex-1 min-w-0 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white/50 text-sm"
                      />
                      <button 
                        onClick={handleSend} 
                        className="flex-shrink-0 px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm whitespace-nowrap"
                      >
                        ì „ì†¡
                      </button>
                    </div>
                  </div>
                </>
              ) : (
                <div className="flex-1 flex items-center justify-center text-gray-500">
                  ì¹œêµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }
    
    // ì•Œë¦¼ ëª¨ë‹¬
    function FriendRequestsModal({ onClose, friendRequests, onAccept, onReject }) {
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-white rounded-xl p-6 max-w-lg w-full max-h-[600px] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold">ì¹œêµ¬ ìš”ì²­</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            {friendRequests.length === 0 ? (
              <div className="text-center py-8 text-gray-500">ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤</div>
            ) : (
              <div className="space-y-3">
                {friendRequests.map((req) => (
                  <div key={req.id} className="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                    <div>
                      <div className="font-medium">{req.users.nickname}</div>
                      <div className="text-sm text-gray-500">ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤</div>
                    </div>
                    <div className="flex space-x-2">
                      <button 
                        onClick={() => onAccept(req.id, req.user_id)} 
                        className="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600"
                      >
                        ìˆ˜ë½
                      </button>
                      <button 
                        onClick={() => onReject(req.id)} 
                        className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600"
                      >
                        ê±°ì ˆ
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }
    
    // ì¹œêµ¬ ëª¨ë‹¬
    function FriendsModal({ user, onClose, onAddFriend, onAccept, onReject }) {
      const [friendNickname, setFriendNickname] = React.useState('');
      const [friends, setFriends] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      
      React.useEffect(() => {
        loadFriends();
      }, []);
      
      const loadFriends = async () => {
        try {
          const { data, error } = await supabase
            .from('friendships')
            .select(`
              friend_id,
              users!friendships_friend_id_fkey(id, nickname, email)
            `)
            .eq('user_id', user.id)
            .eq('status', 'accepted');
          
          if (error) throw error;
          setFriends((data || []).map(f => f.users));
        } catch (error) {
          console.error('ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        } finally {
          setLoading(false);
        }
      };
      
      const handleAdd = async () => {
        await onAddFriend(friendNickname);
        setFriendNickname('');
        await loadFriends();
      };
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[600px] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold">ì¹œêµ¬</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <div className="mb-6">
              <div className="flex space-x-2">
                <input
                  type="text"
                  value={friendNickname}
                  onChange={(e) => setFriendNickname(e.target.value)}
                  placeholder="ì¹œêµ¬ ë‹‰ë„¤ì„ ì…ë ¥"
                  className="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
                <button onClick={handleAdd} className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center">
                  <UserPlus className="w-5 h-5 mr-1" />
                  ì¶”ê°€
                </button>
              </div>
            </div>
            
            <div>
              <h3 className="font-bold mb-2">ì¹œêµ¬ ëª©ë¡ ({friends.length})</h3>
              {loading ? (
                <div className="text-center py-4 text-gray-500">ë¡œë”© ì¤‘...</div>
              ) : friends.length === 0 ? (
                <div className="text-center py-4 text-gray-500">ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
              ) : (
                <div className="space-y-2">
                  {friends.map((friend) => (
                    <div key={friend.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div>
                        <div className="font-medium">{friend.nickname}</div>
                        <div className="text-sm text-gray-500">{friend.email}</div>
                      </div>
                      <Check className="w-5 h-5 text-green-500" />
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }
    
    // ê´€ë¦¬ì í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸
    function AdminPage({ onClose, onApprove, onReject }) {
      const [suggestions, setSuggestions] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      
      React.useEffect(() => {
        fetchSuggestions();
      }, []);
      
      const fetchSuggestions = async () => {
        try {
          const { data, error } = await supabase
            .from('idol_suggestions')
            .select('id, name, song, "videoId", color, suggested_by, status, created_at')
            .eq('status', 'pending')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          
          // videoIdê°€ ì—†ìœ¼ë©´ videoidë¡œ ë§¤í•‘
          const mappedData = (data || []).map(sug => ({
            ...sug,
            videoId: sug.videoId || sug.videoid
          }));
          
          setSuggestions(mappedData);
        } catch (error) {
          console.error('ì œì•ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
        } finally {
          setLoading(false);
        }
      };
      
      const handleApprove = async (suggestion) => {
        await onApprove(suggestion);
        fetchSuggestions();
      };
      
      const handleReject = async (id) => {
        await onReject(id);
        fetchSuggestions();
      };
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-white rounded-xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold">ê´€ë¦¬ì í˜ì´ì§€ - ì•„ì´ëŒ ì œì•ˆ ìŠ¹ì¸</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            {loading ? (
              <div className="text-center py-12 text-gray-500">
                <div className="animate-pulse">ë¡œë”© ì¤‘...</div>
              </div>
            ) : suggestions.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                ëŒ€ê¸° ì¤‘ì¸ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤
              </div>
            ) : (
              <div className="space-y-4">
                {suggestions.map(suggestion => (
                  <div key={suggestion.id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <h3 className="text-lg font-bold text-gray-800">{suggestion.name}</h3>
                        <p className="text-sm text-gray-600">ëŒ€í‘œê³¡: {suggestion.song}</p>
                        <p className="text-xs text-gray-500 mt-1">Video ID: {suggestion.videoId}</p>
                        <p className="text-xs text-gray-500">ì œì•ˆì: {suggestion.suggested_by}</p>
                        <p className="text-xs text-gray-400">
                          {new Date(suggestion.created_at).toLocaleString('ko-KR')}
                        </p>
                        <div className={`mt-2 inline-block px-3 py-1 rounded text-xs bg-gradient-to-r ${suggestion.color} text-white`}>
                          ë¯¸ë¦¬ë³´ê¸° ìƒ‰ìƒ
                        </div>
                      </div>
                      <div className="flex space-x-2 ml-4">
                        <button
                          onClick={() => handleApprove(suggestion)}
                          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
                        >
                          âœ“ ìŠ¹ì¸
                        </button>
                        <button
                          onClick={() => handleReject(suggestion.id)}
                          className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium"
                        >
                          âœ— ê±°ë¶€
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TheDuckGo />);
    
    // Service Worker ë“±ë¡ (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('ServiceWorker registration successful:', registration.scope);
          })
          .catch((error) => {
            console.log('ServiceWorker registration failed:', error);
          });
      });
    }
    
    // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ (ì„ íƒì‚¬í•­)
      console.log('PWA ì„¤ì¹˜ ê°€ëŠ¥!');
    });
    
    // PWA ì„¤ì¹˜ í•¨ìˆ˜ (ë‚˜ì¤‘ì— ë²„íŠ¼ì— ì—°ê²° ê°€ëŠ¥)
    window.installPWA = async () => {
      if (!deferredPrompt) {
        alert('ì´ë¯¸ ì„¤ì¹˜ë˜ì—ˆê±°ë‚˜ ì„¤ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('PWA ì„¤ì¹˜ ì™„ë£Œ!');
      }
      
      deferredPrompt = null;
    };
  </script>
</body>
</html>
